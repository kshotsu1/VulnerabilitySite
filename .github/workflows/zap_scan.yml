name: OWASP Zap Scan
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Print debugging information
        run: |
          echo "Python version: $(python --version)"
          echo "Working Directory: $(pwd)"
          echo "Contents of Working Directory: $(ls -l)"

      - name: Start the Flask application
        run: |
          nohup python ./vulnerability_codes/src/app.py &
          echo $! > flask_pid.txt
          sleep 10

      # - name: Login to Flask application
      #   run: |
      #     curl -X POST http://127.0.0.1:5000/login \
      #     -H "Content-Type: application/x-www-form-urlencoded" \
      #     -d "user_id=sato2&password=st_pass"

      - name: ZAP Scan
        uses: zaproxy/action-full-scan@v0.11.0
        timeout-minutes: 40
        with:
          # token: ${{ secrets.MY_PATH }}
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'http://127.0.0.1:5000'
          # target: 'http://127.0.0.1:5000/login'
          # rules_file_name: '.zap/rules.tsv'
          cmd_options: '-d'
          issue_title: '[TEST]ZAP Scan Report'
          artifact_name: '[TEST]zap report'

      - name: Stop the Flask application
        run: |
          kill $(cat flask_pid.txt)

      # - name: Upload ZAP Report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: zap-report
      #     path: zap_report.html  # 保存したレポートのパス

      # - name: Send email with test report
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     # server_address: smtp.example.com
      #     # server_port: 587
      #     # username: ${{ secrets.SMTP_USERNAME }}
      #     # password: ${{ secrets.SMTP_PASSWORD }}
      #     subject: ZAP Scan Report
      #     body: Please find the attached ZAP scan report.
      #     to: mai.honda@uniadex.co.jp
      #     from: github-actions@example.com
      #     attachments: zap_report.html  # 添付するレポートのパス
